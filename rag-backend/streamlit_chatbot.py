import os
import uuid

import requests
import streamlit as st


host = os.getenv("BACKEND_HOST", "http://127.0.0.1:8000")


def streaming_response(message: str, session_id: str, model: str):
    url = f"{host}/v1/chat/{model}/stream"
    param = {"message": message, "session_id": session_id}

    with requests.post(url, json=param, stream=True, timeout=120) as r:
        for chunk in r.iter_content(chunk_size=1024, decode_unicode=True):
            yield chunk


st.set_page_config(page_title="ë¯¸ë˜ì—ì…‹ ì±—ë´‡ ìƒë‹´ì›", page_icon="ğŸ¤–", layout="wide")

model = st.selectbox("Choose a model", ["gpt", "clova"])

st.title(f"{model}")

if "session_id" not in st.session_state:
    st.session_state.session_id = str(uuid.uuid4())

if "messages" not in st.session_state:
    st.session_state.messages = []

with st.chat_message("assistant"):
    st.markdown(
        "ì•ˆë…•í•˜ì„¸ìš” ë¯¸ë˜ì—ì…‹ ì±—ë´‡ ìƒë‹´ì› ì…ë‹ˆë‹¤. ì•„ë˜ì™€ ê°™ì€ ëª…ë ¹ì„ ì§€ì›í•©ë‹ˆë‹¤."
    )
    # st.markdown(
    #     "1. 2009ë…„ 4ì›” 10ì¼ìƒ ë‚¨ìê°€ í—¬ìŠ¤ì¼€ì–´ ê±´ê°•ë³´í—˜ì˜ ê°€ì…í•˜ë ¤ê³  í•˜ëŠ”ë°, 90ì„¸ ë§Œê¸°ì¼ ë•Œ ë³´í—˜ë£Œ ë‚©ì…ê¸°ê°„ì˜ ì¢…ë¥˜ë¥¼ ì•Œë ¤ì¤˜."
    # )
    # st.markdown(
    #     "2. ì‚¬ë¬´ì§ì— ì¢…ì‚¬í•˜ëŠ” 40ì„¸ ë‚¨ìê°€ ì¼ë°˜ì•”ì„ 1ì²œë§Œì› ê°€ì…í• ê±´ë°, ê³ ì•¡ì•”ì€ ì–¼ë§ˆê¹Œì§€ ê°€ì… ê°€ëŠ¥í•œì§€ ì•Œë ¤ì¤˜."
    # )
    # st.markdown(
    #     "3. ê³ ê°ì´ ì‹¬ì¥ë³‘ì„ ê±±ì •í•˜ê³  ìˆì–´ì„œ í•´ë‹¹ ì§ˆí™˜ ê´€ë ¨ëœ ë³´ì¥ì„ ë°›ê³  ì‹¶ì€ë°, ì–´ë–¤ íŠ¹ì•½ë“¤ì„ ê°€ì…í•˜ë©´ ë ì§€ ì•Œë ¤ì¤˜."
    # )
    # st.markdown(
    #     "4. 66ì„¸ ë‚¨ìì¸ë° í—¬ìŠ¤ì¼€ì–´ ê±´ê°•ë³´í—˜ 90ì„¸ ë§Œê¸°ë¥¼ ê°€ì…í•˜ë ¤ê³  í•  ë•Œ ë‚©ì…ê¸°ê°„ ì–´ë–¤ ê²ƒë“¤ì´ ê°€ëŠ¥í•œì§€ ì•Œë ¤ì¤˜."
    # )
    # st.markdown("5. ì—¬ìë§Œ ê°€ì…í•  ìˆ˜ ìˆëŠ” íŠ¹ì•½ë“¤ì„ ì•Œë ¤ì¤˜.")
    # st.markdown(
    #     "6. ì‘ë…„ 3ì›”ì— ì‹¬ê·¼ê²½ìƒ‰ì¦ ì¹˜ë£Œê°€ ëë‚¬ê³  ì¬ë°œì€ ì—†ëŠ” 50ì„¸ ì—¬ì„±ì¸ë° ì†Œì•¡ì‚¬ë§ ì¸ìˆ˜ê°€ ê°€ëŠ¥í• ê¹Œ?"
    # )
    # st.markdown("7. ì‹¬ê·¼ê²½ìƒ‰ì¦ì— ê±¸ë¦° 30ì„¸ ì—¬ìì¸ë° ì‚¬ë§ë‹´ë³´ ê°€ì…ì´ ê°€ëŠ¥í• ê¹Œ?")
    # st.markdown(
    #     "8. 50ì„¸ ë‚¨ìê°€ ì½”ë¡œë‚˜19 í•©ë³‘ì¦ìœ¼ë¡œ ë™ë„¤ë³‘ì›ì—ì„œ í†µì›ì¹˜ë£Œ ë°›ì•˜ê³ , ì…ì›ì¹˜ë£Œë„ í–ˆì–´ìš”. ì§ˆë³‘ì…ì› ê°€ì… ê°€ëŠ¥í• ê¹Œìš”?"
    # )
    # st.markdown("9. ì‹ ìš°ì‹ ì—¼ì— ê±¸ë¦° 30ì„¸ ì—¬ìì¸ë° ì§ˆë³‘ì…ì› ë‹´ë³´ ê°€ì…ì´ ê°€ëŠ¥í• ê¹Œ?")
    # st.markdown(
    #     "10. ì‹ ìš°ì‹ ì—¼ ì™„ì¹˜ë˜ì—ˆê³  ì¹˜ë£Œ ì¢…ë£Œ 6ê°œì›”ì´ ì§€ë‚¬ì–´ìš”. í•©ë³‘ì¦ì€ ì—†ìŠµë‹ˆë‹¤. ì†Œì•¡ì‚¬ë§ ì¸ìˆ˜ ê°€ëŠ¥í• ê¹Œìš”?"
    # )
    # st.markdown(
    #     "11. ì½”ë¡œë‚˜ì— ê±¸ë ¤ì„œ ì¹˜ë£Œë¥¼ ë°›ì•˜ì—ˆëŠ”ë° í•„ìš”í•œ ì„œë¥˜ëŠ” ì–´ë–¤ ê²ƒë“¤ì´ ìˆì„ê¹Œìš”??"
    # )
    # st.markdown("12. í—¬ìŠ¤ì¼€ì–´ ê±´ê°•ë³´í—˜ì— ë¶€ê°€ ê°€ëŠ¥í•œ íŠ¹ì•½ì„ ì•Œë ¤ì£¼ì„¸ìš”.")
    # st.markdown("13. 72ì„¸ ë‚¨ì„±ì´ í—¬ìŠ¤ì¼€ì–´ ê±´ê°•ë³´í—˜ì´ ê°€ì…ê°€ëŠ¥í• ê¹Œìš”?")
    # st.markdown("13. 72ì„¸ ë‚¨ì„±ì´ ê°€ì…ê°€ëŠ¥í•œ ë³´í—˜ê¸°ê°„, ë‚©ì…ê¸°ê°„ì„ ì•Œë ¤ì£¼ì„¸ìš”.")
    # st.markdown(
    #     "14. 65ì„¸ ì—¬ì„±ì¸ ê²½ìš° ë‡Œí˜ˆê´€ì§ˆí™˜ì§„ë‹¨íŠ¹ì•½ê³¼ ë‡Œí˜ˆê´€ì§ˆí™˜ì‚°ì •íŠ¹ë¡€ëŒ€ìƒë³´ì¥íŠ¹ì•½ ê°€ì…ê¸ˆì•¡ í•œë„ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”."
    # )
    # st.markdown(
    #     "15. í—¬ìŠ¤ì¼€ì–´ ê±´ê°•ë³´í—˜ì˜ ì•”ì§„ë‹¨íŠ¹ì•½ê³¼ ìœ ì‚¬ì•”ì§„ë‹¨íŠ¹ì•½ ìµœëŒ€ê°€ì…ê¸ˆì•¡ì„ ì•Œë ¤ì£¼ì„¸ìš”."
    # )
    # st.markdown(
    #     "16. 23ë…„ 1ì›”ë¶€í„° íë ´, ê¸°ê´€ì§€ì—¼ì„ ë³µìš©ì¤‘ì¸ 52ì„¸ ë‚¨ì„±ì´ ê°€ì…ê°€ëŠ¥í•œ ë‹´ë³´ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”"
    # )
    # st.markdown(
    #     "17. ~~22ë…„ 4ì›”ë¶€í„° ë‹¹ë‡¨ë¥¼ ì§„ë‹¨ë°›ì€ ì—¬ì„±, ë‹¹í™”í˜ˆìƒ‰ì†Œ 6.2, í•©ë³‘ì¦ ì—†ëŠ” ê²½ìš° ì‚¬ë§ê¸‰ë¶€ ê°€ì…ê°€ëŠ¥í•œê°€ìš”?~~"
    # )
    # st.markdown(
    #     "18. 22ë…„ 4ì›”ë¶€í„° ë§Œì„±ì‹ ìš°ì—¼ ì§„ë‹¨ì„ ë°›ëŠ” ì—¬ì ì†Œì•¡ì‚¬ë§ ê°€ì… ê°€ëŠ¥í•œê°€ìš”?"
    # )
    # st.markdown(
    #     "19. 21ë…„ 2ì›” ëŒ€ì¥ìš©ì¢… ì œê±°í•œ ì´ë ¥ì´ ìˆëŠ” 40ì„¸ ë‚¨ì„±ì˜ ê²½ìš° ì•”ì§„ë‹¨, ì…ì›ê¸‰ë¶€ ê°€ì…ì´ ê°€ëŠ¥í•œê°€ìš”?"
    # )
    # st.markdown(
    #     "20. ëª©ë””ìŠ¤í¬ë¡œ 1ë…„ì „ ì…ì›ì¹˜ë£Œí•œ ì´ë ¥ì´ ìˆëŠ”ê²½ìš° ì…ì›,ìˆ˜ìˆ ê¸‰ë¶€ ê°€ì…ì´ ê°€ëŠ¥í•œê°€ìš”?"
    # )
    # st.markdown(
    #     "21. í—ˆë¦¬ê°€ ì‚ë—í•˜ì—¬ 3ë…„ì „ ì…ì›ì¹˜ë£Œí•œ ì´ë ¥ì´ ìˆëŠ”ê²½ìš° ì…ì›,ìˆ˜ìˆ ê¸‰ë¶€ ê°€ì…ì´ ê°€ëŠ¥í•œê°€ìš”?"
    # )
    # st.markdown(
    #     "Note: í˜„ì¬ ì¶”ê°€ ê°€ëŠ¥í•œ ë‹´ë³´ëŠ” ```ì•”, ì†Œì•¡ì‚¬ë§, ì§ˆë³‘ì…ì›``` ìœ¼ë¡œ ì œí•œë©ë‹ˆë‹¤."
    # )
    # st.markdown(
    #     "Note: í˜„ì¬ ì‹¬ì‚¬ ê°€ëŠ¥í•œ ì§ˆë³‘ì€ ```ë§Œì„±ì‹ ìš°ì‹ ì—¼, ì½”ë¡œë‚˜19 í•©ë³‘ì¦, ì‹¬ê·¼ê²½ìƒ‰ì¦, íë ´, ê¸°ê´€ì§€ì—¼``` ìœ¼ë¡œ ì œí•œë©ë‹ˆë‹¤."
    # )

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

if prompt := st.chat_input("What's up?"):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        session_id = st.session_state.session_id
        response = st.write_stream(
            streaming_response(message=prompt, model=model, session_id=session_id),
        )
    st.session_state.messages.append({"role": "assistant", "content": response})
